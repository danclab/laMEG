

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Anatomical Predictors of Laminar Inference Accuracy &#8212; laMEG 0.1.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'auto_tutorials/tutorial_07_anatomy_inference_accuracy';</script>
    <link rel="canonical" href="https://danclab.github.io/laMEG/auto_tutorials/tutorial_07_anatomy_inference_accuracy.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Laminar CSD analysis" href="tutorial_06_csd.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
    <p class="title logo__title">lameg</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Tutorials gallery
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/danclab/laMEG">
                    GitHub
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/danclab/laMEG" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/danc_labo" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Tutorials gallery
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/danclab/laMEG">
                    GitHub
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/danclab/laMEG" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/danc_labo" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorial_01_surface_processing.html">Surface processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_02_model_comparison_free_energy.html">Laminar model comparison using free energy</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_03_model_comparison_cv_error.html">Laminar model comparison using cross-validation error</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_04_sliding_win_model_comparison.html">Sliding time window laminar model comparison using free energy</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_05_roi_power_analysis.html">Laminar ROI analysis of power in source space</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_06_csd.html">Laminar CSD analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Anatomical Predictors of Laminar Inference Accuracy</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Tutorials gallery</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Anatomical Predictors of Laminar Inference Accuracy</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-tutorials-tutorial-07-anatomy-inference-accuracy-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="anatomical-predictors-of-laminar-inference-accuracy">
<span id="sphx-glr-auto-tutorials-tutorial-07-anatomy-inference-accuracy-py"></span><h1>Anatomical Predictors of Laminar Inference Accuracy<a class="headerlink" href="#anatomical-predictors-of-laminar-inference-accuracy" title="Permalink to this heading">#</a></h1>
<p>In [Szul et al., 2025, Beyond deep versus superficial: true laminar inference with MEG](<a class="reference external" href="https://doi.org/10.1101/2025.05.28.656642">https://doi.org/10.1101/2025.05.28.656642</a>), we showed that even under ideal conditions (high SNR, perfect co-registration), the accuracy of laminar MEG source reconstruction varies regionally across the cortex.
This tutorial demonstrates how to compute vertex-wise anatomical predictors that explain this spatial variability using <cite>laMEG</cite> utilities.</p>
<section id="compute-anatomical-features">
<h2>Compute anatomical features<a class="headerlink" href="#compute-anatomical-features" title="Permalink to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">from</span> <span class="nn">lameg.invert</span> <span class="kn">import</span> <span class="n">coregister</span><span class="p">,</span> <span class="n">invert_ebb</span><span class="p">,</span> <span class="n">get_lead_field_rms_diff</span>
<span class="kn">from</span> <span class="nn">lameg.surf</span> <span class="kn">import</span> <span class="n">LayerSurfaceSet</span>
<span class="kn">from</span> <span class="nn">lameg.util</span> <span class="kn">import</span> <span class="n">get_fiducial_coords</span>
<span class="kn">from</span> <span class="nn">lameg.viz</span> <span class="kn">import</span> <span class="n">show_surface</span><span class="p">,</span> <span class="n">color_map</span>
<span class="kn">import</span> <span class="nn">spm_standalone</span>

<span class="c1"># Subject information for data to use</span>
<span class="n">subj_id</span> <span class="o">=</span> <span class="s1">&#39;sub-104&#39;</span>
<span class="n">ses_id</span> <span class="o">=</span> <span class="s1">&#39;ses-01&#39;</span>

<span class="c1"># Fiducial coil coordinates</span>
<span class="n">fid_coords</span> <span class="o">=</span> <span class="n">get_fiducial_coords</span><span class="p">(</span><span class="n">subj_id</span><span class="p">,</span> <span class="s1">&#39;../test_data/participants.tsv&#39;</span><span class="p">)</span>

<span class="c1"># Data file to base simulations on</span>
<span class="n">data_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="s1">&#39;../test_data&#39;</span><span class="p">,</span>
    <span class="n">subj_id</span><span class="p">,</span>
    <span class="s1">&#39;meg&#39;</span><span class="p">,</span>
    <span class="n">ses_id</span><span class="p">,</span>
    <span class="sa">f</span><span class="s1">&#39;spm/spm-converted_autoreject-</span><span class="si">{</span><span class="n">subj_id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ses_id</span><span class="si">}</span><span class="s1">-001-btn_trial-epo.mat&#39;</span>
<span class="p">)</span>

<span class="n">spm</span> <span class="o">=</span> <span class="n">spm_standalone</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</pre></div>
</div>
<p>We’ll use a forward model using the multilayer mesh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">surf_set</span> <span class="o">=</span> <span class="n">LayerSurfaceSet</span><span class="p">(</span><span class="n">subj_id</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<p>We’re going to copy the data file to a temporary directory and direct all output there.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract base name and path of data file</span>
<span class="n">data_path</span><span class="p">,</span> <span class="n">data_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
<span class="n">data_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">data_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Where to put simulated data</span>
<span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

<span class="c1"># Copy data files to tmp directory</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_base</span><span class="si">}</span><span class="s1">.mat&#39;</span><span class="p">),</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_base</span><span class="si">}</span><span class="s1">.mat&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_base</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">),</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_base</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Construct base file name for simulations</span>
<span class="n">base_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_base</span><span class="si">}</span><span class="s1">.mat&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>First we need to run source reconstruction in order to get the lead field information</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Patch size to use for inversion (in this case it matches the simulated patch size)</span>
<span class="n">patch_size</span> <span class="o">=</span> <span class="mi">5</span>
<span class="c1"># Number of temporal modes to use for EBB inversion</span>
<span class="n">n_temp_modes</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># Coregister data to multilayer mesh</span>
<span class="n">coregister</span><span class="p">(</span>
    <span class="n">fid_coords</span><span class="p">,</span>
    <span class="n">base_fname</span><span class="p">,</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">spm_instance</span><span class="o">=</span><span class="n">spm</span>
<span class="p">)</span>

<span class="c1"># Run inversion</span>
<span class="p">[</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">invert_ebb</span><span class="p">(</span>
    <span class="n">base_fname</span><span class="p">,</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span>
    <span class="n">n_temp_modes</span><span class="o">=</span><span class="n">n_temp_modes</span><span class="p">,</span>
    <span class="n">spm_instance</span><span class="o">=</span><span class="n">spm</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Compute vertex-wise anatomical predictors</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">thickness</span>    <span class="o">=</span> <span class="n">surf_set</span><span class="o">.</span><span class="n">get_cortical_thickness</span><span class="p">()</span>              <span class="c1"># Cortical thickness (mm)</span>
<span class="n">lf_rms_diff</span>  <span class="o">=</span> <span class="n">get_lead_field_rms_diff</span><span class="p">(</span><span class="n">base_fname</span><span class="p">,</span> <span class="n">surf_set</span><span class="p">)</span>  <span class="c1"># Lead-field variability across depth</span>
<span class="n">orientations</span> <span class="o">=</span> <span class="n">surf_set</span><span class="o">.</span><span class="n">get_radiality_to_scalp</span><span class="p">()</span>              <span class="c1"># Column orientation relative to scalp</span>
<span class="n">distances</span>    <span class="o">=</span> <span class="n">surf_set</span><span class="o">.</span><span class="n">get_distance_to_scalp</span><span class="p">()</span>               <span class="c1"># Cortical distance to scalp (mm)</span>
</pre></div>
</div>
<p>Each predictor captures a distinct anatomical constraint on laminar inference:</p>
<p><strong>Cortical thickness:</strong> thicker patches of cortices have more separable laminar fields.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span><span class="mi">99</span><span class="p">)]</span>

<span class="c1"># Plot change in power on each surface</span>
<span class="n">colors</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">(</span>
    <span class="n">thickness</span><span class="p">,</span>
    <span class="s2">&quot;Spectral_r&quot;</span><span class="p">,</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;N&#39;</span>
<span class="p">)</span>

<span class="n">cam_view</span> <span class="o">=</span> <span class="p">[</span><span class="mi">335</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">show_surface</span><span class="p">(</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">camera_view</span><span class="o">=</span><span class="n">cam_view</span>
<span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/tutorial_07_thickness.png"><img alt="" src="../_images/tutorial_07_thickness.png" style="width: 800px;" /></a>
<p><strong>Lead-field RMS difference</strong>: quantifies the difference in lead field patterns between the deepest and most superficial vertices; higher values indicate stronger layer separation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">lf_rms_diff</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">lf_rms_diff</span><span class="p">,</span><span class="mi">99</span><span class="p">)]</span>

<span class="c1"># Plot change in power on each surface</span>
<span class="n">colors</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">(</span>
    <span class="n">lf_rms_diff</span><span class="p">,</span>
    <span class="s2">&quot;Spectral_r&quot;</span><span class="p">,</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;N&#39;</span>
<span class="p">)</span>

<span class="n">cam_view</span> <span class="o">=</span> <span class="p">[</span><span class="mi">335</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">show_surface</span><span class="p">(</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">camera_view</span><span class="o">=</span><span class="n">cam_view</span>
<span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/tutorial_07_lf_rms_diff.png"><img alt="" src="../_images/tutorial_07_lf_rms_diff.png" style="width: 800px;" /></a>
<p><strong>Orientation</strong>: measures dipole alignment with scalp normals (1 = radial, 0 = tangential).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span><span class="mi">99</span><span class="p">)]</span>

<span class="c1"># Plot change in power on each surface</span>
<span class="n">colors</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">(</span>
    <span class="n">orientations</span><span class="p">,</span>
    <span class="s2">&quot;Spectral_r&quot;</span><span class="p">,</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;N&#39;</span>
<span class="p">)</span>

<span class="n">cam_view</span> <span class="o">=</span> <span class="p">[</span><span class="mi">335</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">show_surface</span><span class="p">(</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">camera_view</span><span class="o">=</span><span class="n">cam_view</span>
<span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/tutorial_07_orientation.png"><img alt="" src="../_images/tutorial_07_orientation.png" style="width: 800px;" /></a>
<p><strong>Distance</strong>: reflects the distance to the scalp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="mi">99</span><span class="p">)]</span>

<span class="c1"># Plot change in power on each surface</span>
<span class="n">colors</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">(</span>
    <span class="n">distances</span><span class="p">,</span>
    <span class="s2">&quot;Spectral_r&quot;</span><span class="p">,</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;N&#39;</span>
<span class="p">)</span>

<span class="n">cam_view</span> <span class="o">=</span> <span class="p">[</span><span class="mi">335</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">show_surface</span><span class="p">(</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">camera_view</span><span class="o">=</span><span class="n">cam_view</span>
<span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/tutorial_07_distance.png"><img alt="" src="../_images/tutorial_07_distance.png" style="width: 800px;" /></a>
<p>## Normalize and combine predictors
To assess joint contributions of these features, we standardize (z-score) each anatomical predictor and form a composite ‘anatomical score’:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Z-score normalization (invert distance since smaller = closer to sensors)</span>
<span class="n">z_thickness</span>     <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">thickness</span><span class="p">)</span>
<span class="n">z_lf_rms_diff</span>   <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">lf_rms_diff</span><span class="p">)</span>
<span class="n">z_orient</span>    <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">orientations</span><span class="p">)</span>
<span class="n">z_inv_dist</span>  <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="o">-</span><span class="n">distances</span><span class="p">)</span>

<span class="c1"># Composite anatomical score</span>
<span class="n">anatomical_score</span> <span class="o">=</span> <span class="n">z_thickness</span> <span class="o">+</span> <span class="n">z_lf_rms_diff</span> <span class="o">+</span> <span class="n">z_orient</span> <span class="o">+</span> <span class="n">z_inv_dist</span>

<span class="n">c_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">anatomical_score</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">anatomical_score</span><span class="p">,</span><span class="mi">99</span><span class="p">)]</span>

<span class="c1"># Plot change in power on each surface</span>
<span class="n">colors</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">(</span>
    <span class="n">anatomical_score</span><span class="p">,</span>
    <span class="s2">&quot;Spectral_r&quot;</span><span class="p">,</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">c_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;N&#39;</span>
<span class="p">)</span>

<span class="n">cam_view</span> <span class="o">=</span> <span class="p">[</span><span class="mi">335</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
            <span class="mi">60</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">show_surface</span><span class="p">(</span>
    <span class="n">surf_set</span><span class="p">,</span>
    <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">camera_view</span><span class="o">=</span><span class="n">cam_view</span>
<span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/tutorial_07_anatomical_score.png"><img alt="" src="../_images/tutorial_07_anatomical_score.png" style="width: 800px;" /></a>
<p>We can find the best vertex over the whole brain for laminar inference. It happens to be the same one we’ve been using in the tutorial simulations. Isn’t that a coincidence!?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vertex with maximal predicted laminar discriminability</span>
<span class="n">best_vertex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">anatomical_score</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Highest anatomical score at vertex </span><span class="si">{</span><span class="n">best_vertex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="interpretation">
<h2>Interpretation<a class="headerlink" href="#interpretation" title="Permalink to this heading">#</a></h2>
<p>Vertices with higher anatomical_score values are predicted to yield more accurate laminar inference. That is, lower reconstruction error when differentiating deep vs. superficial sources. In Szul et al., 2025, this multivariate anatomical score closely paralleled empirical reconstruction accuracy maps, highlighting regions where laminar separation is anatomically favorable.</p>
</section>
<section id="selecting-anatomical-priors-within-a-region-of-interest">
<h2>Selecting anatomical priors within a region of interest<a class="headerlink" href="#selecting-anatomical-priors-within-a-region-of-interest" title="Permalink to this heading">#</a></h2>
<p>In practical laminar inference, it is often desirable to constrain model comparison to a subset of vertices, e.g., within an anatomical ROI or around vertices showing maximal task-related power or signal amplitude.
Within such a region, the anatomical score can guide the choice of the most anatomically suitable prior location for laminar inference:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Among the vertex in roi_idx, select the vertex with the best anatomical suitability</span>
<span class="n">candidate_anat_scores</span> <span class="o">=</span> <span class="n">anatomical_score</span><span class="p">[</span><span class="n">roi_idx</span><span class="p">]</span>
<span class="n">prior_idx</span> <span class="o">=</span> <span class="n">roi_idx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">candidate_anat_scores</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spm</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

<span class="c1"># Delete simulation files</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.000 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorials-tutorial-07-anatomy-inference-accuracy-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/4c43336e540dec69c0317ce0c5085c16/tutorial_07_anatomy_inference_accuracy.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">tutorial_07_anatomy_inference_accuracy.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/9f6da66ed1b8e3aa738913942ba0875e/tutorial_07_anatomy_inference_accuracy.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">tutorial_07_anatomy_inference_accuracy.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="tutorial_06_csd.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Laminar CSD analysis</p>
      </div>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-anatomical-features">Compute anatomical features</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-anatomical-priors-within-a-region-of-interest">Selecting anatomical priors within a region of interest</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  
  <div class="tocsection editthispage">
    <a href="https://github.com/danclab/laMEG/edit/master/docs/auto_tutorials/tutorial_07_anatomy_inference_accuracy.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/auto_tutorials/tutorial_07_anatomy_inference_accuracy.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2024, DANC lab.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>